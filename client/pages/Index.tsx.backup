import { useState, useEffect } from "react";
import { BookingRequest, ApiResponse } from "@shared/api";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import {
  Calendar,
  Clock,
  Shield,
  Users,
  MapPin,
  Star,
  User,
  LogOut,
  Mail,
} from "lucide-react";
import { Link, useNavigate } from "react-router-dom";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

interface User {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  role: string;
  createdAt: string;
  updatedAt: string;
}

export default function Index() {
  const [bookingType, setBookingType] = useState<"vin" | "manual">("vin");
  const [formData, setFormData] = useState({
    vin: "",
    make: "",
    model: "",
    year: "",
    address: "",
    phone: "",
    email: "",
    notes: "",
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitMessage, setSubmitMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);
  const [user, setUser] = useState<User | null>(null);
  const [showEmailVerification, setShowEmailVerification] = useState(false);
  const [isVerifyingEmail, setIsVerifyingEmail] = useState(false);
  const navigate = useNavigate();

  // Check for logged-in user on component mount
  useEffect(() => {
    const token = localStorage.getItem("authToken");
    const userData = localStorage.getItem("user");

    if (token && userData) {
      try {
        const parsedUser = JSON.parse(userData) as User;
        setUser(parsedUser);

        // Pre-fill email and phone if user is logged in
        setFormData((prev) => ({
          ...prev,
          email: parsedUser.email,
          phone: parsedUser.phone,
        }));
      } catch (error) {
        console.error("Failed to parse user data:", error);
        localStorage.removeItem("authToken");
        localStorage.removeItem("user");
      }
    }
  }, []);

  const handleLogout = () => {
    localStorage.removeItem("authToken");
    localStorage.removeItem("user");
    setUser(null);
    setFormData((prev) => ({
      ...prev,
      email: "",
      phone: "",
    }));
  };

  const handleSendEmailVerification = async () => {
    if (!user) return;

    setIsVerifyingEmail(true);
    try {
      const response = await fetch("/api/auth/send-otp", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          identifier: user.email,
          type: "email",
          purpose: "verify_email",
        }),
      });

      const result = await response.json();

      if (result.success) {
        setSubmitMessage({
          type: "success",
          text: "Verification email sent! Check your email for the OTP code.",
        });
      } else {
        throw new Error(result.message || "Failed to send verification email");
      }
    } catch (error) {
      setSubmitMessage({
        type: "error",
        text:
          error instanceof Error
            ? error.message
            : "Failed to send verification email",
      });
    } finally {
      setIsVerifyingEmail(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setSubmitMessage(null);

    try {
      // Validate required fields
      if (
        !formData.address?.trim() ||
        !formData.phone?.trim() ||
        !formData.email?.trim()
      ) {
        throw new Error("Please fill in all required fields");
      }

      if (bookingType === "vin" && !formData.vin?.trim()) {
        throw new Error("Please enter your vehicle VIN");
      }

      if (
        bookingType === "manual" &&
        (!formData.make?.trim() ||
          !formData.model?.trim() ||
          !formData.year?.trim())
      ) {
        throw new Error("Please fill in all vehicle information");
      }

      const bookingRequest: BookingRequest = {
        vehicleInfo:
          bookingType === "vin"
            ? { vin: formData.vin.trim() }
            : {
                make: formData.make.trim(),
                model: formData.model.trim(),
                year: formData.year.trim(),
              },
        serviceAddress: formData.address.trim(),
        customerInfo: {
          phone: formData.phone.trim(),
          email: formData.email.trim(),
        },
        notes: formData.notes?.trim() || undefined,
      };

      const response = await fetch("/api/bookings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(bookingRequest),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result: ApiResponse = await response.json();

      if (!result.success) {
        throw new Error(result.message || "Failed to create booking");
      }

      setSubmitMessage({
        type: "success",
        text: "Booking submitted successfully! We'll contact you shortly to confirm your appointment.",
      });

      // Reset form
      setFormData({
        vin: "",
        make: "",
        model: "",
        year: "",
        address: "",
        phone: "",
        email: "",
        notes: "",
      });
    } catch (error) {
      console.error("Booking submission error:", error);

      // Log additional details for debugging
      if (error instanceof Error) {
        console.error("Error details:", {
          message: error.message,
          stack: error.stack,
          bookingType,
          formData: {
            ...formData,
            // Don't log sensitive data completely
            email: formData.email ? "***@***" : "",
            phone: formData.phone ? "***-***-****" : "",
          },
        });
      }

      setSubmitMessage({
        type: "error",
        text:
          error instanceof Error
            ? error.message
            : "Failed to submit booking. Please try again.",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                <div className="w-4 h-4 bg-white rounded-full"></div>
              </div>
              <span className="text-xl font-bold text-gray-900">OilSync</span>
            </div>
            <nav className="hidden md:flex space-x-8">
              <Link
                to="/services"
                className="text-gray-600 hover:text-primary transition-colors"
              >
                Services
              </Link>
              <Link
                to="/pricing"
                className="text-gray-600 hover:text-primary transition-colors"
              >
                Pricing
              </Link>
              <Link
                to="/about"
                className="text-gray-600 hover:text-primary transition-colors"
              >
                About
              </Link>
            </nav>
            <div className="flex items-center space-x-4">
              {user ? (
                <>
                  {!user.email?.includes("@verified") && (
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleSendEmailVerification}
                      disabled={isVerifyingEmail}
                      className="border-orange-200 text-orange-700 hover:bg-orange-50"
                    >
                      <Mail className="w-4 h-4 mr-2" />
                      {isVerifyingEmail ? "Sending..." : "Verify Email"}
                    </Button>
                  )}
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button
                        variant="outline"
                        size="sm"
                        className="flex items-center space-x-2"
                      >
                        <User className="w-4 h-4" />
                        <span>
                          {user.firstName} {user.lastName}
                        </span>
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem onClick={() => navigate("/profile")}>
                        <User className="w-4 h-4 mr-2" />
                        Profile
                      </DropdownMenuItem>
                      {user.role === "admin" && (
                        <DropdownMenuItem>
                          <Link
                            to="/admin"
                            className="flex items-center w-full"
                          >
                            <Shield className="w-4 h-4 mr-2" />
                            Admin Dashboard
                          </Link>
                        </DropdownMenuItem>
                      )}
                      <DropdownMenuItem onClick={handleLogout}>
                        <LogOut className="w-4 h-4 mr-2" />
                        Sign Out
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </>
              ) : (
                <>
                  <Link to="/login">
                    <Button variant="outline" size="sm">
                      Sign In
                    </Button>
                  </Link>
                  <Link to="/register">
                    <Button size="sm">Get Started</Button>
                  </Link>
                </>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <section className="py-20 lg:py-32">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid lg:grid-cols-2 gap-12 items-center">
            <div className="space-y-8">
              <div className="space-y-4">
                <Badge className="bg-primary/10 text-primary border-primary/20">
                  Professional Service
                </Badge>
                <h1 className="text-4xl lg:text-6xl font-bold text-gray-900 leading-tight">
                  Oil Change <span className="text-primary">At Your Door</span>
                </h1>
                <p className="text-xl text-gray-600 leading-relaxed">
                  Skip the wait. Skip the drive. Professional oil change service
                  that comes to you. Book in minutes, get service in hours.
                </p>
              </div>
              <div className="flex flex-wrap gap-6 text-sm">
                <div className="flex items-center space-x-2">
                  <Shield className="w-5 h-5 text-primary" />
                  <span className="text-gray-600">Licensed & Insured</span>
                </div>
                <div className="flex items-center space-x-2">
                  <Clock className="w-5 h-5 text-primary" />
                  <span className="text-gray-600">Same Day Service</span>
                </div>
                <div className="flex items-center space-x-2">
                  <Users className="w-5 h-5 text-primary" />
                  <span className="text-gray-600">Expert Technicians</span>
                </div>
              </div>
            </div>

            {/* Booking Form */}
            <Card className="shadow-xl border-0">
              <CardHeader className="pb-4">
                <CardTitle className="text-2xl">Book Your Service</CardTitle>
                <CardDescription>
                  Quick and easy oil change booking
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                {user && !user.email?.includes("@verified") && (
                  <Alert className="border-orange-200 bg-orange-50">
                    <Mail className="h-4 w-4 text-orange-600" />
                    <AlertDescription className="text-orange-800">
                      Please verify your email address to ensure we can send you
                      booking confirmations.
                      <Button
                        variant="link"
                        className="h-auto p-0 ml-2 text-orange-700 hover:text-orange-900"
                        onClick={handleSendEmailVerification}
                        disabled={isVerifyingEmail}
                      >
                        {isVerifyingEmail
                          ? "Sending..."
                          : "Send verification email"}
                      </Button>
                    </AlertDescription>
                  </Alert>
                )}
                {submitMessage && (
                  <div
                    className={`p-4 rounded-lg ${
                      submitMessage.type === "success"
                        ? "bg-green-50 text-green-800 border border-green-200"
                        : "bg-red-50 text-red-800 border border-red-200"
                    }`}
                  >
                    {submitMessage.text}
                  </div>
                )}
                <form onSubmit={handleSubmit} className="space-y-4">
                  {/* VIN or Manual Entry Toggle */}
                  <div className="grid grid-cols-2 gap-2 p-1 bg-muted rounded-lg">
                    <Button
                      type="button"
                      variant={bookingType === "vin" ? "default" : "ghost"}
                      size="sm"
                      onClick={() => setBookingType("vin")}
                      className="rounded-md"
                    >
                      Enter VIN
                    </Button>
                    <Button
                      type="button"
                      variant={bookingType === "manual" ? "default" : "ghost"}
                      size="sm"
                      onClick={() => setBookingType("manual")}
                      className="rounded-md"
                    >
                      Manual Entry
                    </Button>
                  </div>

                  {/* Vehicle Information */}
                  {bookingType === "vin" ? (
                    <div className="space-y-2">
                      <Label htmlFor="vin">Vehicle VIN</Label>
                      <Input
                        id="vin"
                        placeholder="Enter your 17-character VIN"
                        value={formData.vin}
                        onChange={(e) =>
                          setFormData({ ...formData, vin: e.target.value })
                        }
                        maxLength={17}
                      />
                    </div>
                  ) : (
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor="make">Make</Label>
                        <Select
                          onValueChange={(value) =>
                            setFormData({ ...formData, make: value })
                          }
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Select make" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="toyota">Toyota</SelectItem>
                            <SelectItem value="honda">Honda</SelectItem>
                            <SelectItem value="ford">Ford</SelectItem>
                            <SelectItem value="chevrolet">Chevrolet</SelectItem>
                            <SelectItem value="nissan">Nissan</SelectItem>
                            <SelectItem value="bmw">BMW</SelectItem>
                            <SelectItem value="mercedes">
                              Mercedes-Benz
                            </SelectItem>
                            <SelectItem value="audi">Audi</SelectItem>
                            <SelectItem value="volkswagen">
                              Volkswagen
                            </SelectItem>
                            <SelectItem value="other">Other</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="model">Model</Label>
                        <Input
                          id="model"
                          placeholder="e.g. Camry"
                          value={formData.model}
                          onChange={(e) =>
                            setFormData({ ...formData, model: e.target.value })
                          }
                        />
                      </div>
                      <div className="space-y-2 col-span-2">
                        <Label htmlFor="year">Year</Label>
                        <Select
                          onValueChange={(value) =>
                            setFormData({ ...formData, year: value })
                          }
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Select year" />
                          </SelectTrigger>
                          <SelectContent>
                            {Array.from({ length: 25 }, (_, i) => 2024 - i).map(
                              (year) => (
                                <SelectItem key={year} value={year.toString()}>
                                  {year}
                                </SelectItem>
                              ),
                            )}
                          </SelectContent>
                        </Select>
                      </div>
                    </div>
                  )}

                  {/* Contact Information */}
                  <div className="space-y-4">
                    <div className="space-y-2">
                      <Label htmlFor="address">Service Address</Label>
                      <div className="relative">
                        <MapPin className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                        <Input
                          id="address"
                          placeholder="Where should we come to service your car?"
                          value={formData.address}
                          onChange={(e) =>
                            setFormData({
                              ...formData,
                              address: e.target.value,
                            })
                          }
                          className="pl-10"
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor="phone">Phone</Label>
                        <Input
                          id="phone"
                          type="tel"
                          placeholder="(555) 123-4567"
                          value={formData.phone}
                          onChange={(e) =>
                            setFormData({ ...formData, phone: e.target.value })
                          }
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="email">Email</Label>
                        <Input
                          id="email"
                          type="email"
                          placeholder="your@email.com"
                          value={formData.email}
                          onChange={(e) =>
                            setFormData({ ...formData, email: e.target.value })
                          }
                        />
                      </div>
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="notes">Additional Notes (Optional)</Label>
                      <Textarea
                        id="notes"
                        placeholder="Any special instructions or requests?"
                        value={formData.notes}
                        onChange={(e) =>
                          setFormData({ ...formData, notes: e.target.value })
                        }
                        rows={3}
                      />
                    </div>
                  </div>

                  <Button
                    type="submit"
                    className="w-full"
                    size="lg"
                    disabled={isSubmitting}
                  >
                    <Calendar className="w-4 h-4 mr-2" />
                    {isSubmitting ? "Submitting..." : "Schedule Service"}
                  </Button>
                </form>
              </CardContent>
            </Card>
          </div>
        </div>
      </section>

      {/* Features Section */}
      <section className="py-20 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center space-y-4 mb-16">
            <h2 className="text-3xl lg:text-4xl font-bold text-gray-900">
              Why Choose OilSync?
            </h2>
            <p className="text-xl text-gray-600 max-w-3xl mx-auto">
              We bring professional automotive service directly to your driveway
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-8">
            <div className="text-center space-y-4">
              <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto">
                <Clock className="w-8 h-8 text-primary" />
              </div>
              <h3 className="text-xl font-semibold">Convenient Scheduling</h3>
              <p className="text-gray-600">
                Book online in minutes. Choose a time that works for you.
              </p>
            </div>
            <div className="text-center space-y-4">
              <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto">
                <Users className="w-8 h-8 text-primary" />
              </div>
              <h3 className="text-xl font-semibold">Expert Technicians</h3>
              <p className="text-gray-600">
                Certified professionals with years of experience.
              </p>
            </div>
            <div className="text-center space-y-4">
              <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto">
                <Shield className="w-8 h-8 text-primary" />
              </div>
              <h3 className="text-xl font-semibold">Quality Guarantee</h3>
              <p className="text-gray-600">
                100% satisfaction guarantee on all services.
              </p>
            </div>
          </div>
        </div>
      </section>

      {/* Testimonials */}
      <section className="py-20 bg-muted/30">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center space-y-4 mb-16">
            <h2 className="text-3xl lg:text-4xl font-bold text-gray-900">
              What Our Customers Say
            </h2>
          </div>
          <div className="grid md:grid-cols-3 gap-8">
            {[
              {
                name: "Sarah Johnson",
                location: "Austin, TX",
                review:
                  "Amazing service! The technician arrived on time and did a thorough job. So convenient!",
                rating: 5,
              },
              {
                name: "Mike Chen",
                location: "San Francisco, CA",
                review:
                  "Best decision ever. No more waiting at the shop. Professional and efficient.",
                rating: 5,
              },
              {
                name: "Emily Rodriguez",
                location: "Miami, FL",
                review:
                  "The app makes booking so easy, and the service is top-notch. Highly recommend!",
                rating: 5,
              },
            ].map((testimonial, i) => (
              <Card key={i} className="border-0 shadow-sm">
                <CardContent className="p-6 space-y-4">
                  <div className="flex items-center space-x-1">
                    {Array.from({ length: testimonial.rating }).map((_, j) => (
                      <Star
                        key={j}
                        className="w-4 h-4 fill-yellow-400 text-yellow-400"
                      />
                    ))}
                  </div>
                  <p className="text-gray-600 italic">"{testimonial.review}"</p>
                  <div>
                    <div className="font-semibold text-gray-900">
                      {testimonial.name}
                    </div>
                    <div className="text-sm text-gray-500">
                      {testimonial.location}
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid md:grid-cols-4 gap-8">
            <div className="space-y-4">
              <div className="flex items-center space-x-2">
                <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                  <div className="w-4 h-4 bg-white rounded-full"></div>
                </div>
                <span className="text-xl font-bold">OilSync</span>
              </div>
              <p className="text-gray-400">
                Professional mobile oil change service at your convenience.
              </p>
            </div>
            <div className="space-y-4">
              <h4 className="font-semibold">Services</h4>
              <ul className="space-y-2 text-gray-400">
                <li>
                  <Link
                    to="/services/oil-change"
                    className="hover:text-white transition-colors"
                  >
                    Oil Change
                  </Link>
                </li>
                <li>
                  <Link
                    to="/services/filter-replacement"
                    className="hover:text-white transition-colors"
                  >
                    Filter Replacement
                  </Link>
                </li>
                <li>
                  <Link
                    to="/services/maintenance"
                    className="hover:text-white transition-colors"
                  >
                    Basic Maintenance
                  </Link>
                </li>
              </ul>
            </div>
            <div className="space-y-4">
              <h4 className="font-semibold">Company</h4>
              <ul className="space-y-2 text-gray-400">
                <li>
                  <Link
                    to="/about"
                    className="hover:text-white transition-colors"
                  >
                    About Us
                  </Link>
                </li>
                <li>
                  <Link
                    to="/careers"
                    className="hover:text-white transition-colors"
                  >
                    Careers
                  </Link>
                </li>
                <li>
                  <Link
                    to="/contact"
                    className="hover:text-white transition-colors"
                  >
                    Contact
                  </Link>
                </li>
              </ul>
            </div>
            <div className="space-y-4">
              <h4 className="font-semibold">Support</h4>
              <ul className="space-y-2 text-gray-400">
                <li>
                  <Link
                    to="/help"
                    className="hover:text-white transition-colors"
                  >
                    Help Center
                  </Link>
                </li>
                <li>
                  <Link
                    to="/privacy"
                    className="hover:text-white transition-colors"
                  >
                    Privacy Policy
                  </Link>
                </li>
                <li>
                  <Link
                    to="/terms"
                    className="hover:text-white transition-colors"
                  >
                    Terms of Service
                  </Link>
                </li>
              </ul>
            </div>
          </div>
          <div className="border-t border-gray-800 mt-12 pt-8 text-center text-gray-400">
            <p>&copy; 2024 OilSync. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>
  );
}
